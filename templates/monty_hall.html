{% extends "layout.html" %}

{% block title %}
    Monty Hall
{% endblock %}

{% block main %}

<div class="stage-container">
    <div class="curtain left"></div>
    <div class="curtain right"></div>

    <div class="monty-title">
        The Monty Hall Problem
    </div>

    <div id="hostMessage" class="message-board">
        Choose a Door!
    </div>

    <div class="doors-wrapper">
        <div class="door-container" id="door1" onclick="handleDoorClick(0)">
            <div class="door-back" id="prize0">‚ùì</div> 
            <div class="door" id="doorInner0">
                <div class="door-face door-front">1</div>
            </div>
        </div>
        <div class="door-container" id="door2" onclick="handleDoorClick(1)">
            <div class="door-back" id="prize1">‚ùì</div>
            <div class="door" id="doorInner1">
                <div class="door-face door-front">2</div>
            </div>
        </div>
        <div class="door-container" id="door3" onclick="handleDoorClick(2)">
            <div class="door-back" id="prize2">‚ùì</div>
            <div class="door" id="doorInner2">
                <div class="door-face door-front">3</div>
            </div>
        </div>
    </div>

    <div class="stats-board">
        <div class="stat-box">
            <h4>Win % When Switching</h4>
            <div class="stat-number" id="switchStat">
                --%
            </div>
            <small class="text-muted" id="switchCount">0/0</small>
        </div>
        <div class="stat-box">
            <h4>Win % When Staying</h4>
            <div class="stat-number" id="stayStat">
                --%
            </div>
            <small class="text-muted" id="stayCount">0/0</small>
        </div>
    </div>

</div>

<script>
    // --- SERVER STATS ---
    let stats = {
        switchWins: {{ stats.switch_wins }},
        switchTotal: {{ stats.switch_attempts }},
        stayWins: {{ stats.stay_wins }},
        stayTotal: {{ stats.stay_attempts }}
    };

    // --- GAME STATE ---
    let gameState = 0;
    let carLocation = 0; 
    let userInitialPick = -1;
    let montyOpenedDoor = -1;
    
    const CAR = "üöó";
    const GOAT = "üêê";

    initGame();
    updateStatsDisplay();

    function initGame() {
        gameState = 0;
        userInitialPick = -1;
        montyOpenedDoor = -1;
        carLocation = Math.floor(Math.random() * 3);

        document.getElementById("hostMessage").innerText = "Choose a Door!";
        
        // Reset Doors
        for(let i=0; i<3; i++) {
            let container = document.getElementById("door"+(i+1));
            let inner = document.getElementById("doorInner"+i);
            container.classList.remove("selected");
            inner.classList.remove("open");
            document.getElementById("prize"+i).innerText = (i === carLocation) ? CAR : GOAT;
            
            // Reset cursor
            container.style.cursor = "pointer";
        }
    }

    function handleDoorClick(doorIndex) {
        if(gameState === 0) {
            userInitialPick = doorIndex;
            document.getElementById("door"+(doorIndex+1)).classList.add("selected");
            revealGoat();
        } 
        else if(gameState === 2) {
            if (doorIndex === montyOpenedDoor) return;
            let didSwitch = (doorIndex !== userInitialPick);
            finalizeChoice(didSwitch);
        }
    }

    function revealGoat() {
        gameState = 1;
        let availableDoors = [];
        for(let i=0; i<3; i++) {
            if(i !== userInitialPick && i !== carLocation) {
                availableDoors.push(i);
            }
        }
        montyOpenedDoor = availableDoors[Math.floor(Math.random() * availableDoors.length)];

        document.getElementById("hostMessage").innerText = "Monty reveals a Goat!";

        setTimeout(() => {
            document.getElementById("doorInner"+montyOpenedDoor).classList.add("open");
            document.getElementById("door"+(montyOpenedDoor+1)).style.cursor = "default";
            
            setTimeout(() => {
                promptDecision();
            }, 1000);
        }, 500);
    }

    function promptDecision() {
        gameState = 2;
        let otherDoor = [0,1,2].find(d => d !== userInitialPick && d !== montyOpenedDoor);
        
        document.getElementById("hostMessage").innerText = 
            `Tap Door ${userInitialPick+1} to STAY, or Door ${otherDoor+1} to SWITCH!`;
    }

    function finalizeChoice(didSwitch) {
        gameState = 3;
        
        let finalDoor = userInitialPick;
        if(didSwitch) {
            finalDoor = [0,1,2].find(d => d !== userInitialPick && d !== montyOpenedDoor);
        }

        for(let i=0; i<3; i++) {
            document.getElementById("door"+(i+1)).classList.remove("selected");
        }
        document.getElementById("door"+(finalDoor+1)).classList.add("selected");

        let won = (finalDoor === carLocation);

        document.getElementById("doorInner"+finalDoor).classList.add("open");

        for(let i=0; i<3; i++) {
             document.getElementById("door"+(i+1)).style.cursor = "default";
        }

        if(won) {
            document.getElementById("hostMessage").innerText = "YOU WON A NEW CAR! üöóüí®";
            confettiEffect();
        } else {
            document.getElementById("hostMessage").innerText = "It's a Goat. üêê";
        }

        saveResult(didSwitch, won);

        setTimeout(() => {
            initGame();
        }, 3000);
    }

    function saveResult(switched, won) {
        if(switched) {
            stats.switchTotal++;
            if(won) stats.switchWins++;
        } else {
            stats.stayTotal++;
            if(won) stats.stayWins++;
        }
        updateStatsDisplay();

        fetch('/monty_save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ switched: switched, won: won })
        });
    }

    function updateStatsDisplay() {
        let switchPct = stats.switchTotal === 0 ? 0 : (stats.switchWins / stats.switchTotal * 100).toFixed(1);
        document.getElementById("switchStat").innerText = switchPct + "%";
        document.getElementById("switchCount").innerText = `${stats.switchWins}/${stats.switchTotal}`;

        let stayPct = stats.stayTotal === 0 ? 0 : (stats.stayWins / stats.stayTotal * 100).toFixed(1);
        document.getElementById("stayStat").innerText = stayPct + "%";
        document.getElementById("stayCount").innerText = `${stats.stayWins}/${stats.stayTotal}`;
    }

    function confettiEffect() {
        const stage = document.querySelector('.stage-container');
        for(let i=0; i<60; i++) {
            let c = document.createElement('div');
            c.style.width = '10px'; c.style.height = '10px';
            c.style.background = ['#FFD700', '#DAA520', '#F0E68C', '#B8860B'][Math.floor(Math.random()*4)];
            c.style.position = 'absolute';
            c.style.left = Math.random() * 100 + '%';
            c.style.top = '-10px';
            c.style.transition = `top ${Math.random() * 0.5 + 0.8}s ease-in, opacity 1s`;
            c.style.zIndex = 100;
            stage.appendChild(c);
            
            setTimeout(() => {
                c.style.top = '100%';
                c.style.opacity = 0;
            }, 50);
            
            setTimeout(() => c.remove(), 1500);
        }
    }
</script>
{% endblock %}