{% extends "layout.html" %}

{% block title %}
   Blotchville
{% endblock %}

{% block main %}
<div class="container-fluid py-4">
   <div class="row justify-content-center">
      
       <div class="col-lg-8 mb-4">
           <div class="study-break-wrapper d-flex justify-content-center">
               <div class="study-break-content d-flex flex-column align-items-center justify-content-center">

                   <div class="overhead-structure">
                       <div class="overhead-pole"></div>
                       <div class="overhead-gantry"></div>
                       <div class="street-sign">Welcome to Blotchville</div>
                       <div class="street-sign-hanger left"></div>
                       <div class="street-sign-hanger right"></div>
                       <div class="traffic-light left">
                           <div class="light red"></div>
                           <div class="light yellow"></div>
                           <div class="light green"></div>
                       </div>
                       <div class="traffic-light right">
                           <div class="light red"></div>
                           <div class="light yellow"></div>
                           <div class="light green"></div>
                       </div>
                   </div>

                   <div class="mb-2">
                       <span class="fw-bold">Score:</span>
                       <span id="score">0</span>
                   </div>

                   <button id="startButton" class="btn btn-primary mb-3">
                       Start Game
                   </button>

                   <canvas id="gameCanvas" width="600" height="400" class="study-game-canvas"></canvas>

                   <p id="status" class="mt-3 fw-bold"></p>
               </div>
           </div>
       </div>

       <div class="col-lg-4">
           <div class="street-sign leaderboard-container d-flex flex-column align-items-center">
               
               <img src="/static/stat110-logo.png" alt="Stat 110" class="stat110-logo" style="height:48px; margin-bottom:8px;">
               <span class="fs-4 fw-bold text-blotch-yellow">Leaderboard</span>
               
               <table class="table table-bordered table-sm table-blotchville text-center mb-0">
                   <thead>
                       <tr>
                           <th>Rank</th>
                           <th>User</th>
                           <th>Score</th>
                       </tr>
                   </thead>
                   <tbody>
                       {% for leader in leaders %}
                       <tr>
                           <td>{{ loop.index }}</td>
                           <td>{{ leader.username }}</td>
                           <td class="fw-bold">{{ leader.score }}</td>
                       </tr>
                       {% else %}
                       <tr>
                           <td colspan="3">No scores yet. Be the first!</td>
                       </tr>
                       {% endfor %}
                   </tbody>
               </table>
               
               <div class="small mt-2 text-blotch-yellow">Refresh page to see new scores</div>
           </div>
       </div>

   </div>
</div>

<script>
   (function () {
       const canvas = document.getElementById("gameCanvas");
       const ctx = canvas.getContext("2d");
       const scoreEl = document.getElementById("score");
       const statusEl = document.getElementById("status");
       const startButton = document.getElementById("startButton");

       const laneCount = 3;
       const laneHeight = canvas.height / laneCount;
       const laneCenters = [];
       for (let i = 0; i < laneCount; i++) {
           laneCenters.push(i * laneHeight + laneHeight / 2);
       }

       const bus = { lane: 1, x: 40, width: 90, height: 60 };

       let cars = [];
       let running = false;
       let crashing = false;   
       let shakeEndTime = 0;   
       let lastFrameTime = 0;
       let lastSpawnTime = 0;
       let spawnInterval = 900;
       let score = 0;
       let scoreSubmitted = false;

       function resetGame() {
           bus.lane = 1;
           bus.x = 40;
           cars = [];
           running = false;
           crashing = false;
           lastFrameTime = 0;
           lastSpawnTime = 0;
           score = 0;
           scoreSubmitted = false;
           scoreEl.textContent = "0";
           statusEl.textContent = "";
       }

       function wouldCreateWall(candidateLane, candidateX) {
           const windowStart = 180;
           const windowEnd = 380;
           const lanesBlocked = new Set();
           for (let car of cars) {
               const carLeft = car.x;
               const carRight = car.x + car.width;
               if (!(carRight < windowStart || carLeft > windowEnd)) {
                   lanesBlocked.add(car.lane);
               }
           }
           const candLeft = candidateX;
           const candRight = candidateX + 90;
           if (!(candRight < windowStart || candLeft > windowEnd)) {
               lanesBlocked.add(candidateLane);
           }
           return lanesBlocked.size === laneCount;
       }

       function spawnCar() {
           const speed = 220 + Math.random() * 100;
           const spawnX = canvas.width + 120;
           const possibleLanes = [0, 1, 2].sort(() => Math.random() - 0.5);
           let chosenLane = null;
           for (let lane of possibleLanes) {
               if (!wouldCreateWall(lane, spawnX)) {
                   chosenLane = lane;
                   break;
               }
           }
           if (chosenLane === null) return;
           cars.push({
               lane: chosenLane,
               x: spawnX,
               width: 90,
               height: 60,
               speed: speed,
           });
       }

       function update(dt, timestamp) {
           if (crashing) {
               if (timestamp > shakeEndTime) {
                   showGameOverScreen();
               }
               return;
           }

           for (let car of cars) {
               car.x -= car.speed * dt;
           }

           cars = cars.filter(car => car.x > -150);

           for (let car of cars) {
               if (car.lane === bus.lane) {
                   const busLeft = bus.x;
                   const busRight = bus.x + bus.width;
                   const carLeft = car.x;
                   const carRight = car.x + car.width;
                   if (!(busRight < carLeft || busLeft > carRight)) {
                       triggerCrash(timestamp);
                       return;
                   }
               }
           }

           score += dt * 10;
           scoreEl.textContent = Math.floor(score);
       }

       function drawRoad() {
           ctx.fillStyle = "#333";
           ctx.fillRect(0, 0, canvas.width, canvas.height);
           ctx.strokeStyle = "#fff";
           ctx.lineWidth = 4;
           ctx.setLineDash([30, 30]);
           ctx.lineDashOffset = 0;   
           for (let i = 1; i < laneCount; i++) {
               const y = i * laneHeight;
               ctx.beginPath();
               ctx.moveTo(0, y);
               ctx.lineTo(canvas.width, y);
               ctx.stroke();
           }
           ctx.setLineDash([]);
       }

       function drawBus() {
           const y = laneCenters[bus.lane] - bus.height / 2;
           ctx.fillStyle = "#4da6ff";
           ctx.fillRect(bus.x, y, bus.width, bus.height);
           ctx.fillStyle = "#e6f2ff";
           ctx.fillRect(bus.x + 10, y + 10, bus.width - 20, 15);
           ctx.fillStyle = "#222";
           ctx.beginPath();
           ctx.arc(bus.x + 22, y + bus.height - 6, 10, 0, 2 * Math.PI);
           ctx.arc(bus.x + bus.width - 22, y + bus.height - 6, 10, 0, 2 * Math.PI);
           ctx.fill();
       }

       function drawCars() {
           for (let car of cars) {
               const y = laneCenters[car.lane] - car.height / 2;
               ctx.fillStyle = "#ED7014";
               ctx.fillRect(car.x, y + 16, car.width, car.height - 16);
               ctx.fillStyle = "#e0f7fa";
               ctx.fillRect(car.x + 4, y + 24, 18, 18);
               ctx.fillStyle = "#222";
               ctx.beginPath();
               ctx.arc(car.x + 22, y + car.height - 6, 10, 0, 2 * Math.PI);
               ctx.arc(car.x + car.width - 22, y + car.height - 6, 10, 0, 2 * Math.PI);
               ctx.fill();
               ctx.fillStyle = "#ff3333";
               ctx.fillRect(car.x + car.width - 8, y + car.height - 28, 6, 10);
           }
       }

       function draw() {
           ctx.save();
           if (crashing) {
               const dx = (Math.random() - 0.5) * 20;
               const dy = (Math.random() - 0.5) * 20;
               ctx.translate(dx, dy);
           }
           drawRoad();
           drawBus();
           drawCars();
           ctx.restore();
       }

       function triggerCrash(timestamp) {
           crashing = true;
           shakeEndTime = timestamp + 500;
           statusEl.textContent = "CRASH!!!";
       }

       function sendScore(finalScore) {
           if (scoreSubmitted) return;
           scoreSubmitted = true;
           fetch('/submit_score', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ score: Math.floor(finalScore) })
           })
           .then(response => response.json())
           .then(data => { console.log('Score saved:', data); })
           .catch(error => { console.error('Error saving score:', error); });
       }

       function showGameOverScreen() {
           running = false;
           crashing = false;
           sendScore(score);
           statusEl.textContent = "Crash! Press Play Again to retry.";
           startButton.textContent = "Play Again";
           ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
           ctx.fillRect(0, 0, canvas.width, canvas.height);
           ctx.fillStyle = "#fff";
           ctx.font = "24px system-ui, sans-serif";
           ctx.textAlign = "center";
           ctx.fillText("Game Over", canvas.width / 2, canvas.height / 2 - 10);
           ctx.fillText("Score: " + Math.floor(score), canvas.width / 2, canvas.height / 2 + 24);
       }

       function gameLoop(timestamp) {
           if (!running) return;
           if (!lastFrameTime) lastFrameTime = timestamp;
           const dt = (timestamp - lastFrameTime) / 1000;
           lastFrameTime = timestamp;

           if (!crashing) {
               if (!lastSpawnTime) lastSpawnTime = timestamp;
               if (timestamp - lastSpawnTime > spawnInterval) {
                   spawnCar();
                   lastSpawnTime = timestamp;
                   if (spawnInterval > 400) spawnInterval -= 10;
               }
           }
           update(dt, timestamp);
           draw();
           requestAnimationFrame(gameLoop);
       }

       document.addEventListener("keydown", function (event) {
           if (!running || crashing) return;
           if (event.key === "ArrowUp" && bus.lane > 0) {
               bus.lane -= 1;
               event.preventDefault();
           } else if (event.key === "ArrowDown" && bus.lane < laneCount - 1) {
               bus.lane += 1;
               event.preventDefault();
           }
       });

       startButton.addEventListener("click", function () {
           if (scoreSubmitted) {
               window.location.reload();
           } else {
               resetGame();
               running = true;
               startButton.textContent = "Restart";
               requestAnimationFrame(gameLoop);
           }
       });

       drawRoad();
       drawBus();
   })();
</script>
{% endblock %}